name: Template_repo_CI

on:
  push:
  pull_request:

permissions:
  contents: read
  packages: write

jobs:
  lint:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Run linter and format checks
        uses: devcontainers/ci@v0.3
        with:
          runCmd: |
            set -euo pipefail
            echo "üßπ Running linters inside DevContainer..."
            bazel run ruff check /workspaces/flipdot-rpi
            bazel run clang_tidy
            bazel run clang_format_check
            bazel run //tools:buildifier_check_ci
            echo "‚úÖ All linters passed!"

  # Build test inside cached DevContainer
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Test if build succeeds
        uses: devcontainers/ci@v0.3
        with:
          runCmd: |
            set -euo pipefail
            echo "üõ†Ô∏è Building project inside DevContainer..."
            bazel build -- //flipdot/... -//flipdot/src:flipdot_controller_package -//flipdot/src:ros2_package -//flipdot/src:foxglove_bridge_package -//flipdot/src:flipdot_package
            echo "‚úÖ Build succeeded!"
